#!/bin/bash
rm -f changes
rm -f targetfile

rm -f tmpfifo
mkfifo tmpfifo

echo "setup tracing"
./dump-changes &
./trace-changes > tmpfifo &

echo "copy device"
dd if=/dev/loop0 of=targetfile status=progress && kill %1
losetup /dev/loop1 targetfile

for FILE in $(ls -1t changeset/); do
    echo "Replay data from $FILE"
    SIZE=$(stat -c "%s" changeset/$FILE)
    SECTOR=$(echo $FILE | cut -d '.' -f 1)
    dd if=changeset/$FILE seek=$SECTOR count=$(expr $SIZE / 512) of=/dev/loop1 2>/dev/null
done

md5sum /dev/loop0 /dev/loop1

losetup -d /dev/loop1
